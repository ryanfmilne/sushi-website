---
import Layout from "../layouts/Layout.astro";

// Initialize variables for menu items and specials
let featuredMenuItems = [];
let featuredSpecials = [];

try {
  // Import the getCollection function from Astro content
  const { getCollection } = await import("astro:content");

  // Fetch all published menu items
  const menuItems = await getCollection("menu", ({ data }) => {
    return data.published === true;
  });

  // Get one menu item from each category for the featured section
  const categories = [...new Set(menuItems.map((item) => item.data.category))];
  featuredMenuItems = Object.values(
    menuItems.reduce((acc, item) => {
      if (!acc[item.data.category]) {
        acc[item.data.category] = item;
      }
      return acc;
    }, {})
  ).slice(0, 4);

  // Fetch specials
  const specialsItems = await getCollection("specials", ({ data }) => {
    // Show only featured specials or the most recent ones
    return data.featured === true || new Date(data.endDate) >= new Date();
  });

  // Sort specials by endDate (closest ending first) and take top 2
  featuredSpecials = [...specialsItems]
    .sort(
      (a, b) =>
        new Date(a.data.endDate).getTime() - new Date(b.data.endDate).getTime()
    )
    .slice(0, 2);
} catch (error) {
  console.error("Error loading menu items or specials:", error);

  // Provide fallback content if collections aren't available
  featuredMenuItems = [
    {
      data: {
        title: "Caprese Salad",
        price: 12.99,
        description:
          "Fresh mozzarella, heirloom tomatoes, basil, and balsamic glaze.",
        vegetarian: true,
        vegan: false,
        glutenFree: true,
        spicyLevel: 0,
      },
    },
    {
      data: {
        title: "Grilled Salmon",
        price: 24.99,
        description:
          "Wild-caught salmon with roasted vegetables and lemon-dill sauce.",
        vegetarian: false,
        vegan: false,
        glutenFree: true,
        spicyLevel: 0,
      },
    },
  ];

  featuredSpecials = [
    {
      data: {
        title: "Weekend Special",
        startDate: new Date("2025-01-01"),
        endDate: new Date("2025-12-31"),
        description:
          "A delicious weekend special featuring our chef's signature dish.",
        price: 24.99,
        regularPrice: 29.99,
        featured: true,
      },
    },
  ];
}

// Load hours data
let hours = [];
try {
  const hoursData = await import("../content/config/hours.json");
  hours = hoursData.default.hours;
} catch (error) {
  console.error("Error loading hours:", error);
  hours = [
    { day: "Monday", open: "11:00 AM", close: "9:00 PM", closed: false },
    { day: "Tuesday", open: "11:00 AM", close: "9:00 PM", closed: false },
    { day: "Wednesday", open: "11:00 AM", close: "9:00 PM", closed: false },
    { day: "Thursday", open: "11:00 AM", close: "9:00 PM", closed: false },
    { day: "Friday", open: "11:00 AM", close: "10:00 PM", closed: false },
    { day: "Saturday", open: "11:00 AM", close: "10:00 PM", closed: false },
    { day: "Sunday", open: "12:00 PM", close: "8:00 PM", closed: false },
  ];
}

// Get the current day
const currentDay = new Date().toLocaleDateString("en-US", { weekday: "long" });
---

<Layout title="Welcome to Our Restaurant">
  <!-- Hero Section with Fixed Z-Index -->
  <section class="relative">
    <div
      class="h-[70vh] bg-gradient-to-r from-stone-800 to-stone-900 flex items-center">
      <div class="absolute inset-0 overflow-hidden z-0">
        <div class="w-full h-full bg-black opacity-40"></div>
      </div>
      <div class="container mx-auto px-4 relative z-10 text-center">
        <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-white mb-4">
          Experience Culinary Excellence
        </h1>
        <p class="text-xl text-white/80 max-w-2xl mx-auto mb-8">
          Delicious cuisine crafted with passion and the finest ingredients.
        </p>
        <div class="flex flex-wrap justify-center gap-4">
          <a
            href="/menu"
            class="bg-amber-600 hover:bg-amber-700 text-white px-6 py-3 rounded-md font-medium transition-colors">
            View Our Menu
          </a>
          <a
            href="/contact"
            class="bg-white hover:bg-stone-100 text-stone-800 px-6 py-3 rounded-md font-medium transition-colors">
            Make a Reservation
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- About Section -->
  <section class="py-16 bg-stone-50">
    <div class="container mx-auto px-4">
      <div class="max-w-3xl mx-auto text-center">
        <h2 class="text-3xl font-bold mb-6">Our Story</h2>
        <p class="text-lg text-stone-700 mb-6">
          Founded in 2010, our restaurant has been serving the community with
          authentic cuisine made from locally-sourced ingredients. Our chefs
          bring decades of culinary expertise to create memorable dining
          experiences for our guests.
        </p>
        <p class="text-lg text-stone-700">
          We believe in sustainable practices, supporting local farmers, and
          creating dishes that celebrate the rich culinary traditions of our
          region while adding our own unique modern twist.
        </p>
      </div>
    </div>
  </section>

  <!-- Featured Menu Section -->
  <section class="py-16 bg-white">
    <div class="container mx-auto px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl font-bold mb-4">Featured Menu Items</h2>
        <p class="text-lg text-stone-600 max-w-2xl mx-auto">
          Explore some of our most popular dishes, crafted with care and the
          finest ingredients.
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {
          featuredMenuItems.map((item) => (
            <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
              {item.data.image && (
                <div class="relative h-48 bg-gray-200">
                  <img
                    src={item.data.image}
                    alt={item.data.title}
                    class="w-full h-full object-cover"
                    loading="lazy"
                  />
                </div>
              )}
              <div class="p-4">
                <div class="flex justify-between items-start mb-2">
                  <h3 class="text-lg font-semibold">{item.data.title}</h3>
                  <span class="text-amber-600 font-medium">
                    ${item.data.price.toFixed(2)}
                  </span>
                </div>
                <p class="text-stone-600 text-sm mb-3">
                  {item.data.description}
                </p>
                <div class="flex flex-wrap items-center gap-2 mt-auto">
                  {item.data.vegetarian && (
                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-0.5 rounded">
                      Vegetarian
                    </span>
                  )}
                  {item.data.vegan && (
                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-0.5 rounded">
                      Vegan
                    </span>
                  )}
                  {item.data.glutenFree && (
                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-0.5 rounded">
                      Gluten-Free
                    </span>
                  )}
                  {item.data.spicyLevel > 0 && (
                    <div class="flex items-center">
                      <span class="text-xs text-stone-600 mr-1">
                        Spicy: {item.data.spicyLevel}
                      </span>
                    </div>
                  )}
                </div>
              </div>
            </div>
          ))
        }
      </div>

      <div class="text-center mt-8">
        <a
          href="/menu"
          class="inline-flex items-center text-amber-600 font-medium hover:text-amber-700">
          View Full Menu
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-5 h-5 ml-1">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"></path>
          </svg>
        </a>
      </div>
    </div>
  </section>

  <!-- Specials Section -->
  {
    featuredSpecials.length > 0 && (
      <section class="py-16 bg-amber-50">
        <div class="container mx-auto px-4">
          <div class="text-center mb-12">
            <h2 class="text-3xl font-bold mb-4">Current Specials</h2>
            <p class="text-lg text-stone-600 max-w-2xl mx-auto">
              Don't miss our limited-time offers and seasonal specialties.
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
            {featuredSpecials.map((special) => (
              <div
                class={`bg-white rounded-lg shadow-md overflow-hidden ${special.data.featured ? "border-2 border-amber-500" : ""}`}>
                {special.data.image && (
                  <div class="relative h-48 bg-gray-200">
                    <img
                      src={special.data.image}
                      alt={special.data.title}
                      class="w-full h-full object-cover"
                      loading="lazy"
                    />
                  </div>
                )}
                <div class="p-4">
                  <div class="flex flex-col gap-1 mb-3">
                    <h3 class="text-lg font-semibold">{special.data.title}</h3>
                    <div class="text-sm text-stone-500">
                      <span>
                        {new Date(special.data.startDate).toLocaleDateString(
                          "en-US",
                          { month: "short", day: "numeric" }
                        )}{" "}
                        -
                        {new Date(special.data.endDate).toLocaleDateString(
                          "en-US",
                          { month: "short", day: "numeric" }
                        )}
                      </span>
                    </div>
                  </div>

                  <p class="text-stone-600 text-sm mb-3">
                    {special.data.description}
                  </p>

                  <div class="flex items-center gap-2">
                    {special.data.price && (
                      <span class="text-amber-600 font-medium text-lg">
                        ${special.data.price.toFixed(2)}
                      </span>
                    )}
                    {special.data.regularPrice && special.data.price && (
                      <span class="text-stone-500 line-through text-sm">
                        ${special.data.regularPrice.toFixed(2)}
                      </span>
                    )}
                    {special.data.featured && (
                      <span class="bg-amber-100 text-amber-800 text-xs font-medium px-2 py-0.5 rounded ml-auto">
                        Featured
                      </span>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>

          <div class="text-center mt-8">
            <a
              href="/specials"
              class="inline-flex items-center text-amber-600 font-medium hover:text-amber-700">
              View All Specials
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="w-5 h-5 ml-1">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"
                />
              </svg>
            </a>
          </div>
        </div>
      </section>
    )
  }

  <!-- Hours & Reservation Section -->
  <section class="py-16 bg-stone-100">
    <div class="container mx-auto px-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-12 max-w-4xl mx-auto">
        <div>
          <h2 class="text-2xl font-bold mb-6">Hours of Operation</h2>
          <div class="bg-white p-6 rounded-lg shadow-md">
            <ul class="space-y-2">
              {
                hours.map((item) => (
                  <li
                    class={`flex justify-between py-1 border-b border-stone-200 ${item.day === currentDay ? "font-medium" : ""}`}>
                    <span>{item.day}</span>
                    <span class="text-right">
                      {item.closed ? (
                        <span class="text-red-600">Closed</span>
                      ) : (
                        `${item.open} - ${item.close}`
                      )}
                    </span>
                  </li>
                ))
              }
            </ul>
          </div>
        </div>

        <div>
          <h2 class="text-2xl font-bold mb-6">Make a Reservation</h2>
          <div class="bg-white p-6 rounded-lg shadow-md">
            <p class="text-stone-600 mb-4">
              Reserve your table to ensure the best dining experience. We look
              forward to serving you!
            </p>
            <a
              href="/contact"
              class="block w-full bg-amber-600 hover:bg-amber-700 text-white text-center px-6 py-3 rounded-md font-medium transition-colors">
              Contact Us for Reservations
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>
